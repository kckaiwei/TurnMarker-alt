/*! For license information please see turnmarker.js.LICENSE.txt */
(()=>{"use strict";var e={"./src/scripts/chatter.js":(e,t,a)=>{a.r(t),a.d(t,{Chatter:()=>s});var n=a("./src/scripts/settings.js");class s{static sendTurnMessage(e,t=!1){const a=game.i18n.localize("tm.announceLabel");let s,r,i=e.actor.name,m=i;if(n.Settings.getAnnounceTokenName()&&(i=e.token.name,m=e.name),n.Settings.getAnnounceTurnMarkerAlias()?(m=a,s=""):s=`<em>${a}</em>`,n.Settings.getAnnouncePlayerNames()){let t=[];e.players.forEach((e=>{t.push(e.name)})),0==t.length&&t.push("GM"),r=`<p>${t.join(" - ")}</p>`}else r="";t&&!e.actor.hasPlayerOwner&&(i="???"),ChatMessage.create({speaker:{actor:e.actor,alias:m},content:`<div class="flexrow">${this.placeImage(e)}\n                    <div style="flex: 12;">\n                        <h2>${i}'s Turn</h2>\n                        ${r}\n                    </div>\n                    </div>${s}`})}static placeImage(e){if(n.Settings.getIncludeAnnounceImage()){let t=e.img;return e.actor.img&&(t=e.actor.img),`<div style="flex:3;padding-right:4px"><img src="${t}" style="border: none;" /></div>`}return""}}},"./src/scripts/marker.js":(e,t,a)=>{a.r(t),a.d(t,{Marker:()=>r});var n=a("./src/scripts/settings.js"),s=a("./src/scripts/utils.js");class r{static async deleteTurnMarker(){game.user.isGM?await(0,s.deleteTile)({mode:s.socketAction.deleteTurnMarker}):game.socket.emit(s.socketName,{mode:s.socketAction.deleteTurnMarker})}static async deleteOnDeckMarker(){game.user.isGM?await(0,s.deleteTile)({mode:s.socketAction.deleteOnDeckMarker}):game.socket.emit(s.socketName,{mode:s.socketAction.deleteOnDeckMarker})}static async placeTurnMarker(e){if(game.user.isGM&&n.Settings.getIsEnabled("turnmarker")){const t=(0,s.findTokenById)(e);if(void 0!==t){let e=this.getImageDimensions(t,!1,"turnmarker"),a=this.getImageLocation(t,!1,"turnmarker");const s=canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.turnMarker)),r={img:n.Settings.getImagePath(),width:e.w,height:e.h,x:a.x,y:a.y,z:900,rotation:0,hidden:t.hidden,locked:!1};return void(void 0===s?await canvas.scene.createEmbeddedDocuments("Tile",[{...r,flags:{turnMarker:!0}}]):await canvas.scene.updateEmbeddedDocuments("Tile",[{...r,_id:s.id}]))}}await this.deleteTurnMarker()}static async placeOnDeckMarker(e){if(game.user.isGM&&n.Settings.getIsEnabled("deckmarker")){const t=(0,s.findTokenById)(e);if(void 0!==t){let e=this.getImageDimensions(t,!1,"deckmarker"),a=this.getImageLocation(t,!1,"deckmarker"),s=canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.deckMarker));const r={img:n.Settings.getOnDeckImagePath(),width:e.w,height:e.h,x:a.x,y:a.y,z:900,rotation:0,hidden:t.hidden,locked:!1};return void(void 0===s?await canvas.scene.createEmbeddedDocuments("Tile",[{...r,flags:{deckMarker:!0}}]):await canvas.scene.updateEmbeddedDocuments("Tile",[{...r,_id:s.id}]))}}await this.deleteOnDeckMarker()}static async deleteStartMarker(){game.user.isGM?await(0,s.deleteTile)({mode:s.socketAction.deleteStartMarker}):game.socket.emit(s.socketName,{mode:s.socketAction.deleteStartMarker})}static async placeStartMarker(e){if(game.user.isGM&&n.Settings.getIsEnabled("startmarker")){let t=(0,s.findTokenById)(e);if(void 0!==t){let e=this.getImageDimensions(t),a=this.getImageLocation(t),s=canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.startMarker));const r={img:n.Settings.getStartMarker(),width:e.w,height:e.h,x:a.x,y:a.y,z:900,rotation:0,hidden:t.hidden,locked:!1};return void(void 0===s?await canvas.scene.createEmbeddedDocuments("Tile",[{...r,flags:{startMarker:!0}}]):await canvas.scene.updateEmbeddedDocuments("Tile",[{...r,_id:s.id}]))}}await this.deleteStartMarker()}static async moveMarkerToToken(e,t,a="turnmarker"){let n=(0,s.findTokenById)(e);if(void 0!==n){let e=this.getImageDimensions(n,!1,a),s=this.getImageLocation(n,!1,a);await canvas.scene.updateEmbeddedDocuments("Tile",[{_id:t,width:e.w,height:e.h,x:s.x,y:s.y,hidden:n.hidden}])}}static async clearAllMarkers(){await this.deleteTurnMarker(),await this.deleteStartMarker(),await this.deleteOnDeckMarker()}static async updateImagePath(){if(game.user.isGM){let e=canvas.scene.tiles.find((e=>1==e.flags?.turnMarker));e&&await canvas.scene.updateEmbeddedEntity("Tile",[{_id:e.id,img:n.Settings.getImagePath()}])}}static async updateOnDeckImagePath(){if(game.user.isGM){let e=canvas.scene.tiles.find((e=>1==e.flags?.deckMarker));e&&await canvas.scene.updateEmbeddedEntity("Tile",[{_id:e.id,img:n.Settings.getOnDeckImagePath()}])}}static getImageDimensions(e,t=!1,a="turnmarker"){let s=t?1:n.Settings.getRatio(a),r=0,i=0;switch(canvas.grid.type){case 2:case 3:r=i=e.h*s;break;case 4:case 5:r=i=e.w*s;break;default:r=this.getSmallerDimension(e.w,e.h)*s,i=this.getSmallerDimension(e.w,e.h)*s}return{w:r,h:i}}static getSmallerDimension(e,t){return e<t?e:t}static getImageLocation(e,t=!1,a="turnmarker"){let s=t?1:n.Settings.getRatio(a),r=0,i=0;switch(canvas.grid.type){case 2:case 3:r=e.center.x-e.h*s/2,i=e.center.y-e.h*s/2;break;case 4:case 5:r=e.center.x-e.w*s/2,i=e.center.y-e.w*s/2;break;default:r=e.center.x-this.getSmallerDimension(e.w,e.h)*s/2,i=e.center.y-this.getSmallerDimension(e.w,e.h)*s/2}return{x:r,y:i}}}},"./src/scripts/markeranimation.js":(e,t,a)=>{a.r(t),a.d(t,{MarkerAnimation:()=>r});var n=a("./src/scripts/settings.js"),s=a("./src/scripts/utils.js");class r{static startAnimationGM(e="turnmarker"){r.startAnimation(e),game.socket.emit(s.socketName,{startAnimation:e})}static startAnimation(e="turnmarker"){return this.animators||(this.animators={}),e in this.animators?this.animators[e]:(this.animators[e]=this.animateRotation.bind(this,e),canvas.app.ticker.add(this.animators[e]),this.animators)}static stopAnimationGM(e="turnmarker"){r.startAnimation(e),game.socket.emit(s.socketName,{stopAnimation:e})}static stopAnimation(e="turnmarker"){this.animators&&(canvas.app.ticker.remove(this.animators[e]),delete this.animators[e])}static stopAllAnimationGM(){r.stopAllAnimation(),game.socket.emit(s.socketName,{stopAllAnimation:"all"})}static stopAllAnimation(){if(this.animators){for(const[,e]of Object.entries(this.animators))canvas.app.ticker.remove(e);this.animators={}}}static animateRotation(e,t){let a;if(a="deckmarker"===e?canvas.tiles.children.find((e=>1==e.flags?.deckMarker)):canvas.tiles.children.find((e=>1==e.flags?.turnMarker)),a?.img){let e=n.Settings.getInterval()/1e4;try{a.tile.rotation+=e*t}catch(e){}}}}},"./src/scripts/settings.js":(e,t,a)=>{a.r(t),a.d(t,{Settings:()=>E,announcedActorOptions:()=>R,deckImageTitles:()=>P,imageTitles:()=>D});var n=a("./src/scripts/marker.js"),s=a("./src/scripts/markeranimation.js"),r=a("./src/scripts/settingsForm.js"),i=a("./src/scripts/utils.js");const m="tm-version",o="interval",c="announce-turn",g="announce-Actors",d="announce-image",l="announce-token",u="announce-turn-marker-alias",k="announce-player-names",h="image",p="customimage",f="ratio",M="turnmarker-enabled",b="animation",y="ondeckmarker-enabled",v="deckimage",A="customdeckimage",S="deckratio",I="deckanimation",w="deckplayersonly",N="startMarker-enabled",T="startMarker-custom",D=["Runes of Incendium by Rin","Runes of the Cultist by Rin","Runes of Regeneration by Rin","Runes of the Cosmos by Rin","Runes of Earthly Dust by Rin","Runes of Reality by Rin","Runes of the Believer by Rin","Runes of the Mad Mage by Rin","Runes of the Blue Sky by Rin","Runes of the Universe by Rin","Runes of Prosperity by Rin"],P=["Runes of Prosperity by Rin","Runes of Incendium by Rin","Runes of the Cultist by Rin","Runes of Regeneration by Rin","Runes of the Cosmos by Rin","Runes of Earthly Dust by Rin","Runes of Reality by Rin","Runes of the Believer by Rin","Runes of the Mad Mage by Rin","Runes of the Blue Sky by Rin","Runes of the Universe by Rin"],R=["Announce for all","Announce for players","Announce for GM-controlled","Announce all but hide GM-controlled names"];class E{static getVersion(){return game.settings.get(i.modName,m)}static setVersion(e){game.settings.set(i.modName,m,e)}static getRatio(e){switch(e){case"turnmarker":return game.settings.get(i.modName,f);case"deckmarker":return game.settings.get(i.modName,S)}}static setRatio(e){game.settings.set(i.modName,f,e)}static setDeckRatio(e){game.settings.set(i.modName,S,e)}static getShouldAnimate(e){switch(e){case"turnmarker":return game.settings.get(i.modName,b);case"deckmarker":return game.settings.get(i.modName,I)}}static getInterval(){return game.settings.get(i.modName,o)}static shouldAnnounceTurns(){return game.settings.get(i.modName,c)}static setShouldAnnounceTurns(e){game.settings.set(i.modName,c,e)}static getAnnounceActors(){return game.settings.get(i.modName,g)}static setAnnounceActors(e){return game.settings.set(i.modName,g,e)}static getAnnounceTokenName(){return game.settings.get(i.modName,l)}static setAnnounceTokenName(e){return game.settings.set(i.modName,l,e)}static getAnnounceTurnMarkerAlias(){return game.settings.get(i.modName,u)}static setAnnounceTurnMarkerAlias(e){return game.settings.set(i.modName,u,e)}static getAnnouncePlayerNames(){return game.settings.get(i.modName,k)}static setAnnouncePlayerNames(e){return game.settings.set(i.modName,k,e)}static getIncludeAnnounceImage(){return game.settings.get(i.modName,d)}static setIncludeAnnounceImage(e){game.settings.set(i.modName,d,e)}static getImageIndex(e){switch(e){case"turnmarker":return game.settings.get(i.modName,h);case"deckmarker":return game.settings.get(i.modName,v)}}static getStartMarker(){return""==game.settings.get(i.modName,T).trim()?"modules/turnmarker/assets/start.png":game.settings.get(i.modName,T)}static getIsEnabled(e){switch(e){case"turnmarker":return game.settings.get(i.modName,M);case"deckmarker":return game.settings.get(i.modName,y);case"startmarker":return game.settings.get(i.modName,N)}}static setIsEnabled(e,t){switch(e){case"turnmarker":game.settings.set(i.modName,M,t);break;case"deckmarker":game.settings.set(i.modName,y,t);break;case"startmarker":game.settings.set(i.modName,N,t)}}static getStartMarkerPath(){return game.settings.get(i.modName,T)}static setStartMarkerPath(e){game.settings.set(i.modName,T,e)}static getImagePath(){return""==game.settings.get(i.modName,p).trim()?this.getImageByIndex(game.settings.get(i.modName,h)):game.settings.get(i.modName,p)}static getOnDeckImagePath(){return""==game.settings.get(i.modName,A).trim()?this.getDeckImageByIndex(game.settings.get(i.modName,v)):game.settings.get(i.modName,A)}static getImageByIndex(e){switch(e){case 0:return"modules/turnmarker/assets/incendium.png";case 1:return"modules/turnmarker/assets/cultist.png";case 2:return"modules/turnmarker/assets/regeneration.png";case 3:return"modules/turnmarker/assets/cosmos.png";case 4:return"modules/turnmarker/assets/earthlydust.png";case 5:return"modules/turnmarker/assets/reality.png";case 6:return"modules/turnmarker/assets/believer.png";case 7:return"modules/turnmarker/assets/madmage.png";case 8:return"modules/turnmarker/assets/bluesky.png";case 9:return"modules/turnmarker/assets/universe.png";case 10:return"modules/turnmarker/assets/prosperity.png"}}static getDeckImageByIndex(e){switch(e){case 0:return"modules/turnmarker/assets/prosperity.png";case 1:return"modules/turnmarker/assets/incendium.png";case 2:return"modules/turnmarker/assets/cultist.png";case 3:return"modules/turnmarker/assets/regeneration.png";case 4:return"modules/turnmarker/assets/cosmos.png";case 5:return"modules/turnmarker/assets/earthlydust.png";case 6:return"modules/turnmarker/assets/reality.png";case 7:return"modules/turnmarker/assets/believer.png";case 8:return"modules/turnmarker/assets/madmage.png";case 9:return"modules/turnmarker/assets/bluesky.png";case 10:return"modules/turnmarker/assets/universe.png"}}static setImage(e,t){switch(e){case"turnmarker":game.settings.set(i.modName,h,t);break;case"deckmarker":game.settings.set(i.modName,v,t)}}static getCustomImagePath(){return game.settings.get(i.modName,p)}static setCustomImagePath(e){game.settings.set(i.modName,p,e)}static getCustomDeckImagePath(){return game.settings.get(i.modName,A)}static setCustomDeckImagePath(e){game.settings.set(i.modName,A,e)}static getDeckPlayersOnly(){return game.settings.get(i.modName,w)}static setDeckPlayersOnly(e){game.settings.set(i.modName,w,e)}static registerSettings(){game.settings.registerMenu(i.modName,"tm.settingsMenu",{name:"tm.settings.button.name",label:"tm.settings.button.label",icon:"fas fa-sync-alt",type:r.SettingsForm,restricted:!0}),game.settings.register(i.modName,m,{name:`${i.modName} version`,default:"0.0.0",type:String,scope:"world"}),game.settings.register(i.modName,f,{name:"tm.settings.ratio.name",hint:"tm.settings.ratio.hint",scope:"world",config:!1,type:Number,default:1.5,restricted:!0}),game.settings.register(i.modName,b,{name:"tm.settings.animate.name",hint:"tm.settings.animate.hint",scope:"user",config:!0,type:Boolean,default:!0,onChange:e=>{!game.paused&&e&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.data.flags.turnMarker))?s.MarkerAnimation.startAnimationGM("turnmarker"):s.MarkerAnimation.stopAnimationGM("turnmarker")}}),game.settings.register(i.modName,I,{name:"tm.settings.deckAnimate.name",hint:"tm.settings.deckAnimate.hint",scope:"user",config:!0,type:Boolean,default:!0,onChange:e=>{!game.paused&&e&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.data.flags.deckMarker))?s.MarkerAnimation.startAnimationGM("deckmarker"):s.MarkerAnimation.stopAnimationGM("deckmarker")}}),game.settings.register(i.modName,o,{name:"tm.settings.interval.name",hint:"tm.settings.interval.hint",scope:"user",config:!0,type:Number,default:100}),game.settings.register(i.modName,h,{name:"tm.settings.image.name",scope:"world",config:!1,type:Number,default:0,choices:D,restricted:!0,onChange:e=>n.Marker.updateImagePath(e)}),game.settings.register(i.modName,S,{name:"tm.settings.deckRatio.name",hint:"tm.settings.deckRatio.hint",scope:"world",config:!1,type:Number,default:1.5,restricted:!0}),game.settings.register(i.modName,v,{name:"tm.settings.deckImage.name",scope:"world",config:!1,type:Number,default:0,choices:P,restricted:!0,onChange:e=>n.Marker.updateOnDeckImagePath(e)}),game.settings.register(i.modName,A,{name:"tm.settings.customDeckImage.name",hint:"tm.settings.customDeckImage.hint",scope:"world",config:!1,type:String,default:"",restricted:!0,onChange:e=>n.Marker.updateOnDeckImagePath(e)}),game.settings.register(i.modName,y,{name:"tm.settings.onDeckMarkerEnabled.name",hint:"tm.settings.onDeckMarkerEnabled.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0,onChange:e=>{if(e){if(game.combat&&game.combat.combatant&&game.combat.started){let e=(0,i.getNextTurn)(game.combat);n.Marker.placeOnDeckMarker(game.combat.turns[e].token.id)}}else n.Marker.deleteOnDeckMarker()}}),game.settings.register(i.modName,w,{name:"tm.settings.deckPlayersOnly.name",hint:"tm.settings.deckPlayersOnly.hint",scope:"world",config:!1,type:Boolean,default:!0,restricted:!0}),game.settings.register(i.modName,g,{name:"tm.settings.announcedActors.name",hint:"tm.settings.announcedActors.hint",scope:"world",config:!1,type:Number,default:0,restricted:!0,choices:R}),game.settings.register(i.modName,l,{name:"tm.settings.announceTokenName.name",hint:"tm.settings.announceTokenName.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0}),game.settings.register(i.modName,u,{name:"tm.settings.announceTurnMarkerAlias.name",hint:"tm.settings.announceTurnMarkerAlias.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0}),game.settings.register(i.modName,k,{name:"tm.settings.announcePlayerNames.name",hint:"tm.settings.announcePlayerNames.hint",scope:"world",config:!1,type:Boolean,default:!0,restricted:!0}),game.settings.register(i.modName,p,{name:"tm.settings.customImage.name",hint:"tm.settings.customImage.hint",scope:"world",config:!1,type:String,default:"",restricted:!0,onChange:e=>n.Marker.updateImagePath(e)}),game.settings.register(i.modName,c,{name:"tm.settings.announce.name",hint:"tm.settings.announce.hint",scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(i.modName,d,{name:"tm.settings.announceImage.name",hint:"tm.settings.announceImage.hint",scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(i.modName,M,{name:"tm.settings.turnMarkerEnabled.name",hint:"tm.settings.turnMarkerEnabled.hint",scope:"world",config:!1,type:Boolean,default:!0,restricted:!0,onChange:e=>{e?game.combat&&game.combat.combatant&&game.combat.started&&n.Marker.placeTurnMarker(game.combat.combatant.token.id):n.Marker.deleteTurnMarker()}}),game.settings.register(i.modName,N,{name:"tm.settings.startEnabled.name",hint:"tm.settings.startEnabled.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0,onChange:e=>{e?game.combat&&game.combat.combatant&&game.combat.started&&n.Marker.placeStartMarker(game.combat.combatant.token.id):n.Marker.deleteStartMarker()}}),game.settings.register(i.modName,T,{name:"tm.settings.startImage.name",hint:"tm.settings.startImage.hint",scope:"world",config:!1,type:String,default:"",restricted:!0})}}},"./src/scripts/settingsForm.js":(e,t,a)=>{a.r(t),a.d(t,{SettingsForm:()=>r});var n=a("./src/scripts/settings.js");const s=["mp4","webm","ogg"];class r extends FormApplication{constructor(e,t={}){super(e,t)}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"turnmarker-settings-form",title:"Turn Marker - Global Settings",template:"./modules/turnmarker/templates/settings.html",classes:["sheet","tm-settings"],width:500,closeOnSubmit:!0})}getData(){return{turnMarkerEnabled:n.Settings.getIsEnabled("turnmarker"),ratio:n.Settings.getRatio("turnmarker"),image:this.getSelectList(n.imageTitles,n.Settings.getImageIndex("turnmarker")),customImage:n.Settings.getCustomImagePath(),previewPath:n.Settings.getImagePath(),onDeckMarkerEnabled:n.Settings.getIsEnabled("deckmarker"),deckRatio:n.Settings.getRatio("deckmarker"),deckImage:this.getSelectList(n.deckImageTitles,n.Settings.getImageIndex("deckmarker")),customDeckImage:n.Settings.getCustomDeckImagePath(),onDeckPreviewPath:n.Settings.getOnDeckImagePath(),onDeckPlayersOnly:n.Settings.getDeckPlayersOnly(),announceActors:this.getSelectList(n.announcedActorOptions,n.Settings.getAnnounceActors()),announce:n.Settings.shouldAnnounceTurns(),announceImage:n.Settings.getIncludeAnnounceImage(),announceTokenName:n.Settings.getAnnounceTokenName(),announceTurnMarkerAlias:n.Settings.getAnnounceTurnMarkerAlias(),announcePlayerNames:n.Settings.getAnnouncePlayerNames(),startMarkerEnabled:n.Settings.getIsEnabled("startmarker"),startMarkerPath:n.Settings.getStartMarkerPath()}}async _updateObject(e,t){console.log("Turn Marker | Saving Settings"),n.Settings.setRatio(t.ratio),t.image&&n.Settings.setImage("turnmarker",t.image),n.Settings.setCustomImagePath(t.customImage),n.Settings.setIsEnabled("turnmarker",t.turnMarkerEnabled),n.Settings.setShouldAnnounceTurns(t.announce),n.Settings.setAnnounceActors(t.announceActors),n.Settings.setIncludeAnnounceImage(t.announceImage),n.Settings.setAnnounceTokenName(t.announceTokenName),n.Settings.setAnnounceTurnMarkerAlias(t.announceTurnMarkerAlias),n.Settings.setAnnouncePlayerNames(t.announcePlayerNames),n.Settings.setIsEnabled("startmarker",t.startMarkerEnabled),n.Settings.setStartMarkerPath(t.startMarkerPath),n.Settings.setDeckRatio(t.deckRatio),t.deckImage&&n.Settings.setImage("deckmarker",t.deckImage),n.Settings.setCustomDeckImagePath(t.customDeckImage),n.Settings.setIsEnabled("deckmarker",t.onDeckMarkerEnabled),n.Settings.setDeckPlayersOnly(t.onDeckPlayersOnly)}activateListeners(e){super.activateListeners(e);const t=e.find("#image"),a=e.find("#customImage"),s=e.find("#markerImgPreview"),r=e.find("#deckImage"),i=e.find("#customDeckImage"),m=e.find("#onDeckMarkerImgPreview");this.updatePreview(e),t.length>0&&t.on("change",(e=>{""==a[0].value.trim()&&s.attr("src",n.Settings.getImageByIndex(Number(e.target.value)))})),r.length>0&&r.on("change",(e=>{""==i[0].value.trim()&&m.attr("src",n.Settings.getDeckImageByIndex(Number(e.target.value)))})),a.length>0&&a.on("change",(t=>{this.updatePreview(e)})),i.length>0&&i.on("change",(t=>{this.updatePreview(e)}))}updatePreview(e){this._updateTurnmarkerPreview(e),this._updateOnDeckmarkerPreview(e)}_updateTurnmarkerPreview(e){const t=e.find("#image"),a=e.find("#customImage"),r=e.find("#markerImgPreview"),i=e.find("#markerVideoPreview");if(""==a[0].value.trim())t[0].disabled=!1,r.attr("src",n.Settings.getImageByIndex(Number(t[0].value))),r.removeClass("hidden"),i.addClass("hidden");else{t[0].disabled=!0;const e=this.getExtension(a[0].value);s.includes(e.toLowerCase())?(i.attr("src",a[0].value),r.addClass("hidden"),i.removeClass("hidden")):(r.attr("src",a[0].value),r.removeClass("hidden"),i.addClass("hidden"))}}_updateOnDeckmarkerPreview(e){const t=e.find("#deckImage"),a=e.find("#customDeckImage"),r=e.find("#onDeckMarkerImgPreview"),i=e.find("#onDeckMarkerVideoPreview");if(""==a[0].value.trim())t[0].disabled=!1,r.attr("src",n.Settings.getDeckImageByIndex(Number(t[0].value))),r.removeClass("hidden"),i.addClass("hidden");else{t[0].disabled=!0;const e=this.getExtension(a[0].value);s.includes(e.toLowerCase())?(i.attr("src",a[0].value),r.addClass("hidden"),i.removeClass("hidden")):(r.attr("src",a[0].value),r.removeClass("hidden"),i.addClass("hidden"))}}getExtension(e){return e.slice(2+(e.lastIndexOf(".")-1>>>0))}getSelectList(e,t){let a=[];return e.forEach(((e,n)=>{a.push({value:e,selected:n==t})})),a}}},"./src/scripts/updateWindow.js":(e,t,a)=>{a.r(t),a.d(t,{renderUpdateWindow:()=>s});var n=a("./src/scripts/settings.js");function s(){const e=game.modules.get("turnmarker");if(isNewerVersion(e.version,n.Settings.getVersion())){class t extends Application{static get defaultOptions(){return mergeObject(super.defaultOptions,{template:`modules/${e.id}/templates/updateWindow.html`,resizable:!1,width:500,height:600,classes:["updateWindow"],title:`${e.title} - Updated`})}getData(){return{version:e.version}}activateListeners(t){super.activateListeners(t),t.find(".show-again").on("change",(t=>{n.Settings.setVersion(t.currentTarget.checked?e.version:null)}))}}(new t).render(!0)}}},"./src/scripts/utils.js":(e,t,a)=>{a.r(t),a.d(t,{deleteTile:()=>g,findTileById:()=>m,findTokenById:()=>i,firstGM:()=>o,getNextTurn:()=>c,modName:()=>n,socketAction:()=>r,socketName:()=>s});const n="turnmarker",s="module.turnmarker",r={deleteStartMarker:1,deleteTurnMarker:2,deleteOnDeckMarker:3};function i(e){return canvas.tokens.ownedTokens.find((t=>t.id==e))}function m(e){return canvas.background.tiles.find((t=>t.id==e))}function o(){for(let e of game.users.contents)if(e.role===CONST.USER_ROLES.GAMEMASTER&&e.active)return e.id}function c(e){return(e.turn+1)%e.turns.length}async function g({mode:e}={}){let t=null;switch(e){case r.deleteStartMarker:t=canvas.scene.getEmbeddedCollection("Tile")?.filter((e=>!0===e.flags?.startMarker))?.map((e=>e.id)),t?.length>0&&await canvas.scene.deleteEmbeddedDocuments("Tile",t);break;case r.deleteTurnMarker:t=canvas.scene.getEmbeddedCollection("Tile")?.filter((e=>!0===e.flags?.turnMarker))?.map((e=>e.id)),t?.length>0&&await canvas.scene.deleteEmbeddedDocuments("Tile",t);break;case r.deleteOnDeckMarker:t=canvas.scene.getEmbeddedCollection("Tile")?.filter((e=>!0===e.flags?.deckMarker))?.map((e=>e.id)),t?.length>0&&await canvas.scene.deleteEmbeddedDocuments("Tile",t)}}}},t={};function a(n){var s=t[n];if(void 0!==s)return s.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,a),r.exports}a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{a.r(n);var e=a("./src/scripts/chatter.js"),t=a("./src/scripts/marker.js"),s=a("./src/scripts/markeranimation.js"),r=a("./src/scripts/settings.js"),i=a("./src/scripts/updateWindow.js"),m=a("./src/scripts/utils.js");let o="";function c(e){if(e.hidden)return game.user.isGM;const t=new CanvasVisibility(canvas);if(!t.tokenVision)return!0;if(e._controlled)return!0;const a=canvas.scene.tokens.find((e=>e.id===game.combat?.combatant.token.id));if(!a||a.hidden)return game.user.isGM;let n="turnmarker";e.flags.startMarker?n="startmarker":e.flags.deckMarker&&(n="deckmarker");const s=r.Settings.getRatio(n),i=e.width/s,m=e.height/s,o=Math.min(i,m)/4;return t.testVisibility(e.center,{tolerance:o,object:e})}async function g(a,n){if(a.combatant&&n&&o!=a.combatant.id&&game.user.isGM&&game.userId==(0,m.firstGM)()&&a&&a.combatant&&a.started&&(o=a.combatant.id,await t.Marker.placeStartMarker(a.combatant.token.id),await async function(e){const a=(0,m.getNextTurn)(e);r.Settings.getDeckPlayersOnly()?e.turns[a].actor.hasPlayerOwner?await t.Marker.placeOnDeckMarker(e.turns[a].token.id).then((function(){!game.paused&&r.Settings.getShouldAnimate("deckmarker")&&s.MarkerAnimation.startAnimationGM("deckmarker")})):await t.Marker.deleteOnDeckMarker():await t.Marker.placeOnDeckMarker(e.turns[a].token.id).then((function(){!game.paused&&r.Settings.getShouldAnimate("deckmarker")&&s.MarkerAnimation.startAnimationGM("deckmarker")}))}(a),await t.Marker.placeTurnMarker(a.combatant.token.id).then((function(){!game.paused&&r.Settings.getShouldAnimate("turnmarker")&&s.MarkerAnimation.startAnimationGM("turnmarker")})),r.Settings.shouldAnnounceTurns()&&!a.combatant.hidden))switch(r.Settings.getAnnounceActors()){case 0:e.Chatter.sendTurnMessage(a.combatant);break;case 1:a.combatant.actor.hasPlayerOwner&&e.Chatter.sendTurnMessage(a.combatant);break;case 2:a.combatant.actor.hasPlayerOwner||e.Chatter.sendTurnMessage(a.combatant);break;case 3:e.Chatter.sendTurnMessage(a.combatant,!0)}}Hooks.once("init",(()=>{r.Settings.registerSettings()})),Hooks.once("ready",(async()=>{if(game.user.isGM&&isNewerVersion(game.modules.get("turnmarker").version,r.Settings.getVersion())&&(0,i.renderUpdateWindow)(),game.socket.on(m.socketName,(async e=>{game.user.isGM?e.mode&&(0,m.deleteTile)({mode:e.mode}):e.startAnimation?s.MarkerAnimation.startAnimation(e.startAnimation):e.stopAnimation?s.MarkerAnimation.stopAnimation(e.stopAnimation):e.stopAllAnimation&&s.MarkerAnimation.stopAllAnimation()})),game.user.isGM&&(await t.Marker.clearAllMarkers(),game.combat&&g(game.combat,!0)),!game.paused){const e=canvas.scene.getEmbeddedCollection("Tile");r.Settings.getShouldAnimate("turnmarker")&&e?.find((e=>!0===e.flags?.turnMarker))&&s.MarkerAnimation.startAnimation("turnmarker"),r.Settings.getShouldAnimate("deckmarker")&&e?.find((e=>!0===e.flags?.deckMarker))&&s.MarkerAnimation.startAnimation("deckmarker")}})),Hooks.on("updateCombat",(async(e,a)=>{e.started||await t.Marker.clearAllMarkers(),"swade"!=game.system.id&&g(e,a)})),Hooks.on("renderCombatTracker",(async(e,t)=>{"swade"==game.system.id&&g(e.viewed,t)})),Hooks.on("deleteCombat",(async()=>{await t.Marker.clearAllMarkers(),s.MarkerAnimation.stopAllAnimationGM()})),Hooks.on("updateToken",(async(e,a,n,s)=>{const r=canvas.scene.getEmbeddedCollection("Tile");let i=r?.find((e=>1==e.flags?.deckMarker));if(i&&(a.x||a.y||a.width||a.height||a.hidden)&&game.combat&&game.user.isGM&&game.userId===(0,m.firstGM)()){const e=(0,m.getNextTurn)(game.combat),a=game.combat.turns[e].token;await t.Marker.moveMarkerToToken(a.id,i.id,"deckmarker")}i=r?.find((e=>1==e.flags?.turnMarker)),i&&(a.x||a.y||a.width||a.height||a.hidden)&&game.combat?.combatant?.token.id===a._id&&game.user.isGM&&game.userId===(0,m.firstGM)()&&await t.Marker.moveMarkerToToken(a._id,i.id,"turnmarker")})),Hooks.on("updateTile",(e=>{if(e.flags?.turnMarker||e.flags?.startMarker||e.flags?.deckMarker){const t=canvas.scene.getEmbeddedCollection("Tile").find((t=>t.id===e.id));t&&(t.renderable=c(t))}})),Hooks.on("sightRefresh",(()=>{const e=canvas.scene.getEmbeddedCollection("Tile");for(const t of e)(t.flags?.turnMarker||t.flags?.startMarker||t.flags?.deckMarker)&&(t.renderable=c(t))})),Hooks.on("pauseGame",(e=>{e?s.MarkerAnimation.stopAllAnimation():(r.Settings.getShouldAnimate("turnmarker")&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.turnMarker))&&s.MarkerAnimation.startAnimation("turnmarker"),r.Settings.getShouldAnimate("deckmarker")&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.deckMarker))&&s.MarkerAnimation.startAnimation("deckmarker"))}))})()})();
//# sourceMappingURL=turnmarker.js.map